import numpy as np
from operator import add, sub, mul, pow
from tai.opt import opt
from tai.wl import *
from schedule import wolf

# 为了优化计算速度生成的规则列表，支持嵌套0到8层

# 你也可以使用下面的Mathematica代码生成嵌套规则
# Rep[s_] := StringReplace[s, "E" -> "EES"];
# nl = NestList[Rep, "E", 8]
# "\""~StringJoin~#~StringJoin~"\"" & /@ nl

# E = 常数(16种)， S = 运算符(6种)

nest_rule_sign = [
    "E",
    "EES",
    "EESEESS",
    "EESEESSEESEESSS",
    "EESEESSEESEESSSEESEESSEESEESSSS",
    "EESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSS",
    "EESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSS",
    "EESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSSS",
    "EESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSEESEESSEESEESSSEESEESSEESEESSSSEESEESSEESEESSSEESEESSEESEESSSSSSSS"
]

# 转换为适于计算的list
nest_rule = np.array([ch for ch in nest_rule_sign[opt.depth].replace("E", "16").replace("S", "6")], dtype=int)
print(nest_rule)

# 运算符字典，耦合度高，勿随意变更
using_operators = {
    "1": add,
    "2": sub,
    "3": mul,
    "4": lambda x, y: x / y,
    "5": pow,
    "6": lambda x: x
}

# 定义参与运算的常数，如果使用了 Wolfram 引擎可以更简明地定义
# 在wl.py中设置常量

if opt.enable_wolfram:
    values_wolf = wolf.wolfram_evaluate("N[{" + consts_pool + "},17]")
    values = [float(i) for i in list(values_wolf)]

# 兼容非wolfram
else:
    values = [
        3.1415926535897932, 2.7182818284590452, 1.1557273497909217179,
        0.86525597943226508722, 5.8598744820488384738, 0.42331082513074800310,
        8.5397342226735670655, 23.140692632779269006, 22.459157718361045473, 
        9.8696044010893586188,  7.3890560989306502272,  6.2831853071795864769, 
        5.4365636569180904707,  36.462159607207911771, 15.154262241479264190,
        114516.426867869998
    ]

# 变量占位符，形式为 #k
placeholder = [f"#{i+1}" for i in range(len(values))]

# cost映射
cost_dict = {
    "Pi": 1,
    "E": 1,
    "Plus": 3,
    "Times": 12,
    "Power": 72
}